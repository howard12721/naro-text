# Chapter4: Routing 2

この章では、動的的経路制御(Dynamic Routing)の基礎知識とその設定を学びます。

[[toc]]

## Lesson

### 動的経路制御

前の章では、経路上のすべてのルーターに対して手動で経路情報を設定することでパケットのルーティングを実現しました。
しかしこのように手動で設定を行う方法にはいくつか欠点があります。

手動での設定はなんと言っても手間がかかります(体験してもらったように)。
手間がかかるということは設定ミスの機会も多くなります。

そもそも現代の広大なインターネット上に存在するすべてのルーターを把握しつつ、すべてのリクエストに対して適切な経路を手動で設定するというのは現実的ではありませんね。
では、どのように設定を行えばよいでしょうか？

ここで用いられるのが一定の規則に基づいてルーティングテーブルを自動で更新する動的ルーティングです。
IGP(Interior Gateway Protocol)としては`RIP, EIGRP, OSPF, IS-IS`が挙げられます。

### OSPF(Open Shortest Path First)

この講習会では、AS内部のルーティングプロトコルとしてOSPFを採用します。

OSPFはリンクステート型のルーティングアルゴリズムで、単純にネットワークアドレス/サブネットマスクを交換するのではなく、LSA(Link State Advertisement)という形式の情報を交換します。
リンクはOSPFが有効になっているインターフェースで、それぞれのOSPFルータがリンクの状態を交換することで、各OSPFルータがネットワーク構成を詳細に把握することができます。

OSPFルータが交換したLSAはリンクステートデータベース(Link State Database : LSDB)に格納されます。
LSDBは、各OSPFルータが認識している詳細なネットワーク構成図です。

リンクステート情報には、インタフェースの帯域幅に応じて自動的に計算されるパスコストが含まれます。

OSPFでは、LSDBを元にSPFアルゴリズム(ダイクストラアルゴリズム)を用いて各ルータを起点とした最短パスツリーを計算し、ルーティングテーブルを作成・更新します。

LSDBは`エリア`と呼ばれる範囲内で共通です。
大規模なネットワークでは、交換されるリンクステート情報の数とサイズが非常に多くなり、それにともなってLSDBサイズも巨大になってしまうので、エリアという単位で適切に区切ることで効率化する必要があります。

OSPFのエリアは、エリア0(バックボーンエリア)に他のすべてのエリアが隣接する、エリア0を中心とした2階層の構成をとります。

::: info
- AS(Autonomous System)
  - 統一された運用ポリシーによって管理されたネットワークの集まり
  - 詳細はBGPの章で解説します
- ABR(Area Border Router)
  - エリアの境界に位置するABRはエリアごとのLSDBを保持しており、エリア間のルーティングを行います。
  - また、ABRは異なるエリアのリンクステート情報を集約して内部ルータに通知するので内部ルータのLSDBのサイズは縮小できます。
- ASBR(AS Boundary Router)
  - ASの境界に位置するASBRがOSPFを採用していない他のASのルート情報を相互に再配送することでASを超えたルーティングを可能にします。
:::

## Assignment

### 1. OSPFによってr4から各ルーター、および`8.8.8.8`のすべてに`ping`が通るようにしてみよう

::: warning
静的ルーティングの設定が存在する場合、そちらが優先的に参照されることに注意してください。
:::

::: details ヒント1

LSAにはエリアとネットワークの指定が必要です。
:::

::: details ヒント2

インターネットへ接続するにはデフォルトルートを設定する必要があります。
:::

::: details ヒント3

「VyOS OSPF 設定」などで検索してみると良いでしょう。
:::


::: details 答え
各自のネットワークに合わせて変更してください。
[例: r6]
```sh
root@hijiki51-60000:/# attach r6
minion@r6:/$ config
[edit]
minion@r6# set protocols ospf area 0 network 192.168.0.12/30

minion@r6# set protocols ospf area 0 network 192.168.0.24/30

minion@r6# set protocols ospf area 0 network 192.168.0.28/30

minion@r6# commit
minion@r6# save
[edit]
minion@r6# exit
exit
```

OSPFではルーティングアップデートのために、隣接ルータがいる・いないに関係なく、OSPFが有効化されたインターフェースから定期的にHelloパケットが、隣接ルータにむけてマルチキャストで送信されるます。
しかし、隣接ルータがいない場合は、ルーティングアップデートの送信は必要ありません。
そこで、`passive-interface`コマンドを使用することによって、特定のI/Fからの無駄なアップデートを停止することができます。
rEXやr4では`passive-interface`を設定することにも注意してください。

**[rEX]**
```sh
minion@rEX# set protocols ospf passive-interface ens4
```

また、OSPFでもRIPやEIGRPなどのルーティングプロトコルのようにデフォルトルートを生成することができます。
インターネットあてのパケットをルーティングするために、デフォルトルートを利用することが多いです。
他には、スタブエリアから外部ネットワークへの到達性を確保するためにデフォルトルートの生成を行う場合などがあります。

RIPやEIGRPでは、デフォルトルートをスタティックルートとして設定して、再配送することでデフォルトルートの生成できます。
しかし、OSPFではこの方法ではデフォルトルートを生成できません。
スタティックルートをOSPFに再配送しても、デフォルトルートは再配送の対象外です。
OSPFでデフォルトルートを生成するためには、`default-information originate`コマンドを使います。

今回はrEXをデフォルトルートに設定します。

[rEX]
```sh
minion@rEX# set protocols ospf default-information originate always
```

::: info
特別なエリアとして
- Stub Area
- Totaly Stub Area
- NSSA
- Totaly NSSA

が存在します。
:::


### 2. リンクステート情報の変化に応じて、経路が動的に切り替わる様子を確認してみよう


::: details ヒント
リンクステート情報のパスコストを手動で設定すると良いでしょう。
:::


::: details 答え
パスコストを設定することで到達経路を制御できます。

[例: r2]
```sh
minion@r2# set interfaces ethernet eth11 ip ospf cost 200
```

どのような経路を通っているか確認するには`traceroute`コマンドなどを利用してください。


:::